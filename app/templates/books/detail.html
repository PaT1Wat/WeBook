{% extends "base.html" %}

{% block title %}{{ book.title }} - WeBook{% endblock %}

{% block content %}
<div class="book-detail">
    <div class="book-header">
        <div class="book-cover">
            {% if book.thumbnail_url %}
                <img src="{{ book.thumbnail_url }}" alt="{{ book.title }}">
            {% else %}
                <div class="no-image">No Image</div>
            {% endif %}
        </div>
        <div class="book-info">
            <h1>{{ book.title }}</h1>
            <p class="authors"><strong>By:</strong> {{ authors|join(', ') if authors else 'Unknown' }}</p>
            <p class="rating">★ {{ "%.1f"|format(book.average_rating) }} ({{ book.ratings_count }} ratings)</p>
            
            {% if current_user.is_authenticated %}
                <div class="user-actions">
                    {% if is_bookmarked %}
                        <button onclick="toggleBookmark({{ book.id }})" class="btn btn-secondary">Remove Bookmark</button>
                    {% else %}
                        <button onclick="toggleBookmark({{ book.id }})" class="btn btn-primary">Bookmark</button>
                    {% endif %}
                    
                    <div class="rating-widget">
                        <p>Your Rating:</p>
                        <div id="user-rating">
                            {% for i in range(1, 6) %}
                                <span class="star {% if user_rating and i <= user_rating %}filled{% endif %}" 
                                      onclick="rateBook({{ book.id }}, {{ i }})">★</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
            
            {% if book.categories %}
                <p><strong>Categories:</strong> {{ categories|join(', ') }}</p>
            {% endif %}
            
            {% if book.publisher %}
                <p><strong>Publisher:</strong> {{ book.publisher }}</p>
            {% endif %}
            
            {% if book.published_date %}
                <p><strong>Published:</strong> {{ book.published_date }}</p>
            {% endif %}
            
            {% if book.page_count %}
                <p><strong>Pages:</strong> {{ book.page_count }}</p>
            {% endif %}
            
            <div class="book-badges">
                {% if book.is_manga %}
                    <span class="badge">Manga</span>
                {% endif %}
                {% if book.is_novel %}
                    <span class="badge">Novel</span>
                {% endif %}
            </div>
        </div>
    </div>
    
    {% if book.description %}
        <div class="book-description">
            <h2>Description</h2>
            <p>{{ book.description }}</p>
        </div>
    {% endif %}
    
    <div class="book-actions">
        <a href="{{ url_for('recommendations.get_similar_books', book_id=book.id) }}" class="btn btn-secondary">Find Similar Books</a>
        {% if book.preview_link %}
            <a href="{{ book.preview_link }}" target="_blank" class="btn btn-secondary">Preview</a>
        {% endif %}
    </div>
    
    <div class="book-reviews">
        <h2>Reviews</h2>
        <a href="{{ url_for('reviews.get_reviews', book_id=book.id) }}" class="btn btn-primary">View All Reviews</a>
        {% if current_user.is_authenticated %}
            <a href="{{ url_for('reviews.create_review', book_id=book.id) }}" class="btn btn-secondary">Write Review</a>
        {% endif %}
    </div>
</div>

<script>
function toggleBookmark(bookId) {
    const isBookmarked = {{ 'true' if is_bookmarked else 'false' }};
    const method = isBookmarked ? 'DELETE' : 'POST';
    const url = `/books/${bookId}/bookmark`;
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        location.reload();
    })
    .catch(error => {
        alert('Failed to update bookmark');
    });
}

function rateBook(bookId, score) {
    fetch(`/books/${bookId}/rating`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ score: score })
    })
    .then(response => response.json())
    .then(data => {
        location.reload();
    })
    .catch(error => {
        alert('Failed to submit rating');
    });
}
</script>
{% endblock %}
